<!doctype html>
<html itemscope itemtype="http://schema.org/Organization" lang="en">
  <head>
    <base href="/foreman-rex/">
    
    
    

    
    
    
  <title> :: Plugin Manuals</title>

  <script type="text/javascript" src="/foreman-rex/static/js/jquery.js"></script>
  <script type="text/javascript" src="/foreman-rex/static/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/foreman-rex/static/js/jquery-ui-1.9.2.custom.min.js"></script>
  <script type="text/javascript" src="/foreman-rex/static/js/jquery.tocify.min.js"></script>
  <script type="text/javascript" src="/foreman-rex/static/js/scroll.js"></script>

  <link rel="stylesheet" media="all" href="/foreman-rex/static/css/bootstrap.min.css"/>
  <link rel="stylesheet" media="all" href="/foreman-rex/static/css/bootstrap-responsive.min.css"/>
  <link rel="stylesheet" media="all" href="/foreman-rex/static/css/jquery.tocify.css"/>
  <link rel="stylesheet" media="all" href="/foreman-rex/static/css/syntax.css" />
  <link rel="stylesheet" media="all" href="/foreman-rex/static/css/style.css"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0;" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>

<body>
  <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
          <div class="container">
              <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
              <img alt="Foreman" class="logo" src="/foreman-rex/static/images/foreman.png" />
              <div class="brand">
                <a  href="/foreman-rex/">Foreman</a>
                <a class="subtitle" href="/foreman-rex/">Remote Execution</a>
              </div>
              <div class="nav-collapse collapse">
                <ul class="nav">
                  <li><a href="/foreman-rex/">About</a></li>
                  <li><a href="/foreman-rex/design/">Design</a></li>
                </ul>
              </div>
          </div>
      </div>
  </div>
<script>
$(function(){
  $('.nav > li a[href="'+window.location.pathname+'"]').parents('.nav > li').addClass('active')
})
</script>


  <div id="main">
    <div id="content" class="container">
      <div class="row">
        <div id="toc" class="span3">
        </div>
        <div id="doc" class="offset3 span9">
          <h1 id="remote-execution-technology">Remote Execution Technology</h1>

<h2 id="user-stories">User Stories</h2>

<ul>
<li><p>As a user I want to run commands in parallel across large number of
hosts</p></li>
<li><p>As a user I want to run commands on a host in a different network
segment (the host doesn&#39;t see the Foreman server/the Foreman server
doesn&#39;t see the host directly)</p></li>
<li><p>As a user I want to manage a host without installing an agent on it
(just plain old ssh)</p></li>
<li><p>As a community user I want to already existing remote execution
technologies in combination with the Foreman</p></li>
</ul>

<h2 id="design">Design</h2>

<h3 id="ssh-single-host-push">Ssh Single Host Push</h3>

<p><img src='/foreman-rex///images/plantuml/16aebbe8eb0ca9ed26fbd3ea2a7cb704.png'></p>

<p>UserCommand:</p>

<ul>
<li>hosts: [host.example.com]</li>
<li>template: install-packages-ssh</li>
<li>input: { packages: [&#39;vim-X11&#39;] }</li>
</ul>

<p>ProxyCommand:</p>

<ul>
<li>host: host.example.com</li>
<li>provider: ssh</li>
<li>input: &quot;yum install -y vim-X11&quot;</li>
</ul>

<p>SshCommand:</p>

<ul>
<li>host: host.example.com</li>
<li>input: &quot;yum install -y vim-X11&quot;</li>
</ul>

<p>ProgressReport[1, Running]:</p>

<ul>
<li>output: &quot;Resolving depednencies&quot;</li>
</ul>

<p>ProgressReport[2, Running]:</p>

<ul>
<li>output: &quot;installing libXt&quot;</li>
</ul>

<p>AccumulatedProgressReport[1, Running]:</p>

<ul>
<li>output: { stdout: &quot;Resolving depednencies\ninstalling libXt&quot; }</li>
</ul>

<p>ProgressReport[3, Running]:</p>

<ul>
<li>output: &quot;installing vim-X11&quot;</li>
</ul>

<p>ProgressReport[4, Finished]:</p>

<ul>
<li>output: &quot;operation finished successfully&quot;</li>
<li>exit_code: 0</li>
</ul>

<p>AccumulatedProgressReport[2, Finished]:</p>

<ul>
<li>output: { stdout: &quot;installing vim-X11\noperation finished successfully&quot;, exit_code: 0 }</li>
<li>success: true</li>
</ul>

<h3 id="ssh-single-host-pull">Ssh Single Host Pull</h3>

<p><img src='/foreman-rex///images/plantuml/40c71a2b081db9c25ff88fda3fb8485d.png'></p>

<p>UserCommand:</p>

<ul>
<li>hosts: [host.example.com]</li>
<li>template: install-packages-ssh</li>
<li>input: { packages: [&#39;vim-X11&#39;] }</li>
</ul>

<p>ProxyCommand:</p>

<ul>
<li>host: host.example.com</li>
<li>provider: ssh</li>
<li>input: &quot;yum install -y vim-X11&quot;</li>
</ul>

<p>Script:</p>

<ul>
<li>input: &quot;yum install -y vim-X11&quot;</li>
</ul>

<p>ProgressReport[1, Running]:</p>

<ul>
<li>output: &quot;Resolving depednencies&quot;</li>
</ul>

<p>ProgressReport[2, Running]:</p>

<ul>
<li>output: &quot;installing libXt&quot;</li>
</ul>

<p>AccumulatedProgressReport[1, Running]:</p>

<ul>
<li>output: { stdout: &quot;Resolving depednencies\ninstalling libXt&quot; }</li>
</ul>

<p>ProgressReport[3, Running]:</p>

<ul>
<li>output: &quot;installing vim-X11&quot;</li>
</ul>

<p>ProgressReport[4, Finished]:</p>

<ul>
<li>output: &quot;operation finished successfully&quot;</li>
<li>exit_code: 0</li>
</ul>

<p>AccumulatedProgressReport[2, Finished]:</p>

<ul>
<li>output: { stdout: &quot;Resolving depednencies\ninstalling libXt&quot;, exit_code: 0 }</li>
<li>success: true</li>
</ul>

<h3 id="ssh-multi-host">Ssh Multi Host</h3>

<p><img src='/foreman-rex///images/plantuml/df6507a5cb7e9f9fe4203669e758a918.png'></p>

<p>UserCommand:</p>

<ul>
<li>hosts: *.example.com</li>
<li>template: install-packages-ssh</li>
<li>input: { packages: [&#39;vim-X11&#39;] }</li>
</ul>

<p>ProxyCommand[host1]:</p>

<ul>
<li>host: host-1.example.com</li>
<li>provider: ssh</li>
<li>input: &quot;yum install -y vim-X11&quot;</li>
</ul>

<p>ProxyCommand[host2]:</p>

<ul>
<li>host: host-2.example.com</li>
<li>provider: ssh</li>
<li>input: &quot;yum install -y vim-X11&quot;</li>
</ul>

<div class=" alert alert-info">
  <p><strong>Note</strong> </p>

<p>we might want to optimize the communication between server and
the proxy (sending collection of ProxyCommands in bulk, as well as
the AccumulatedProgerssReports). That would could also be utilized
by the Ansible implementation, where there might be optimization
on the invoking the ansible commands at once (the same might apply
to mcollective). On the other hand, this is more an optimization,
not required to be implemented from the day one: but it&#39;s good to have
this in mind</p>

</div>

<h3 id="mcollective-single-host">MCollective Single Host</h3>

<p><img src='/foreman-rex///images/plantuml/3d6f85d2d931ded5ecae64f2bc89c11a.png'></p>

<p>UserCommand:</p>

<ul>
<li>hosts: [host.example.com]</li>
<li>template: install-packages-mco</li>
<li>input: { packages: [&#39;vim-X11&#39;] }</li>
</ul>

<p>ProxyCommand:</p>

<ul>
<li>host: host.example.com</li>
<li>provider: mcollective</li>
<li>input: { agent: package, args: { package =&gt; &#39;vim-X11&#39; } }</li>
</ul>

<p>MCOCommand:</p>

<ul>
<li>host: host.example.com</li>
<li>input: { agent: package, args: { package =&gt; &#39;vim-X11&#39; } }</li>
</ul>

<p>ProgressReport[Finished]:</p>

<ul>
<li>output: [ {&quot;name&quot;:&quot;vim-X11&quot;,&quot;tries&quot;:1,&quot;version&quot;:&quot;7.4.160-1&quot;,&quot;status&quot;:0,&quot;release&quot;:&quot;1.el7&quot;},
          {&quot;name&quot;:&quot;libXt&quot;,&quot;tries&quot;:1,&quot;version&quot;:&quot;1.1.4-6&quot;,&quot;status&quot;:0,&quot;release&quot;:&quot;1.el7&quot;} ]</li>
</ul>

<p>AccumulatedProgressReport[Finished]:</p>

<ul>
<li>output: [ {&quot;name&quot;:&quot;vim-X11&quot;,&quot;tries&quot;:1,&quot;version&quot;:&quot;7.4.160-1&quot;,&quot;status&quot;:0,&quot;release&quot;:&quot;1.el7&quot;},
          {&quot;name&quot;:&quot;libXt&quot;,&quot;tries&quot;:1,&quot;version&quot;:&quot;1.1.4-6&quot;,&quot;status&quot;:0,&quot;release&quot;:&quot;1.el7&quot;} ]</li>
<li>success: true</li>
</ul>

<h3 id="ansible-single-host">Ansible Single Host</h3>

<p><img src='/foreman-rex///images/plantuml/cb5c68d0f0ff412347978b498e5673c2.png'></p>

<p>UserCommand:</p>

<ul>
<li>hosts: [host.example.com]</li>
<li>template: install-packages-ansible</li>
<li>input: { packages: [&#39;vim-X11&#39;] }</li>
</ul>

<p>ProxyCommand:</p>

<ul>
<li>host: host.example.com</li>
<li>provider: ansible</li>
<li>input: { module: yum, args: { name: &#39;vim-X11&#39;, state: installed } }</li>
</ul>

<p>AnsibleCommand:</p>

<ul>
<li>host: host.example.com</li>
<li>provider: ansible</li>
<li>input: { module: yum, args: { name: &#39;vim-X11&#39;, state: installed } }</li>
</ul>

<p>ProgressReport[Finished]:</p>

<ul>
<li>output: { changed: true,
          rc: 0,
          results: [&quot;Resolving depednencies\ninstalling libXt\ninstalling vim-X11\noperation finished successfully&quot;] }</li>
</ul>

<p>AccumulatedProgressReport[Finished]:</p>

<ul>
<li>output: { changed: true,
          rc: 0,
          results: [&quot;Resolving depednencies\ninstalling libXt\ninstalling vim-X11\noperation finished successfully&quot;] }</li>
<li>success: true</li>
</ul>

<h1 id="command-preparation">Command Preparation</h1>

<h2 id="user-stories">User Stories</h2>

<ul>
<li><p>As a user I want to be able to create a template to run some command for a given remote execution provider for a specific job</p></li>
<li><p>As a user these command templates should be audited and versioned</p></li>
<li><p>As a user I want to be able to define inputs into the template that consist of user input at execution time.  I should be able to use these inputs within my template.</p></li>
<li><p>As a user I want to be able to define an input for a template that uses a particular fact about the host being executed on at execution time.</p></li>
<li><p>As a user I want to be able to define an input for a template that uses a particular smart variable that is resolved at execution time.</p></li>
<li><p>As a user I want to be able to define a description of each input in order to help describe the format and meaning of an input.</p></li>
<li><p>As a user I want to be able to specify default number of tries per command template.</p></li>
<li><p>As a user I want to be able to specify default retry interval per command template.</p></li>
<li><p>As a user I want to be able to specify default splay time per command template.</p></li>
<li><p>As a user I want to setup default timeout per command template.</p></li>
<li><p>As a user I want to preview a rendered command template for a host (providing needed inputs)</p></li>
</ul>

<h2 id="design">Design</h2>

<p><img src='/foreman-rex///images/plantuml/1b3c153aa58dd2c5b70603ae29268b42.png'></p>

<h2 id="scenarios">Scenarios</h2>

<p><strong>Creating a command template</strong></p>

<ol>
<li>given I&#39;m on new template form</li>
<li>I select from a list of existing job names or fill in a new job name</li>
<li>I select some option to add an input

<ol>
<li>Give the input a name</li>
<li>Select the type &#39;user input&#39;</li>
<li>Give the input a description (space separated package list)</li>
</ol></li>
<li>I select from a list of known providers (ssh, mco, salt, ansible)</li>
<li>I am shown an example of how to use the input in the template</li>
<li>I am able to see some simple example for the selected provider??</li>
<li>I fill in the template</li>
<li>I select one or more organizations and locations (if enabled)</li>
<li>I click save</li>
</ol>

<p><strong>Creating a smart variable based input</strong></p>

<ol>
<li>given i am creating or editing a command template</li>
<li>I select to add a new input

<ol>
<li>Give the input a name</li>
<li>Define a smart variable name</li>
</ol></li>
</ol>

<h1 id="command-invocation">Command Invocation</h1>

<h2 id="user-stories">User Stories</h2>

<ul>
<li><p>As a user I would like to invoke a job on a single host</p></li>
<li><p>As a user I would like to invoke a job on a set of hosts, based on
search filter</p></li>
<li><p>As a user I want to be able to reuse existing bookmarks for job
invocation</p></li>
<li><p>As a user, when setting a job in future, I want to decide if the
search criteria should be evaluated now or on the execution time</p></li>
<li><p>As a user I want to reuse the target of previous jobs for next execution</p></li>
<li><p>As a CLI user I want to be able to invoke a job via hammer CLI</p></li>
<li><p>As a user, I want to be able to invoke the job on a specific set of hosts
(by using checkboxes in the hosts table)</p></li>
<li><p>As a user, when planning future job execution, I want to see a
warning with the info about unreachable hosts</p></li>
<li><p>As a user I want to be able to override default values like (number
of tries, retry interval, splay time, timeout, remote user...) when I plan an execution of command.</p></li>
<li><p>As a user I expect to see a the description of an input whenever i am being requested to
provide the value for the input.</p></li>
<li><p>As a user I want to be able to re-invoke the jobs based on
success/failure of previous task</p></li>
</ul>

<h2 id="scenarios">Scenarios</h2>

<p><strong>Fill in target for a job</strong></p>

<ol>
<li>when I&#39;m on job invocation form</li>
<li>then I can specify the target of the job using the scoped search
syntax</li>
<li>the target might influence the list of providers available for the
invocation: although, in delayed execution and dynamic targeting the
current list of providers based on the hosts might not be final and
we should count on that.</li>
</ol>

<p><strong>Fill in template inputs for a job</strong></p>

<ol>
<li>given I&#39;m on job invocation form</li>
<li>when I choose the job to execute</li>
<li>then I&#39;m given a list of providers that I have enabled and has a
template available for the job</li>
<li>and each provider allows to choose which template to use for this
invocation (if more templates for the job and provider are available)</li>
<li>and every template has input fields generated based on the input
defined on the template (such as list of packages for install package
job)
<em>OPEN QUESTION</em>: should we unify the common inputs in all templates to
specify them only once?</li>
</ol>

<p><strong>Fill in job description for the execution</strong></p>

<ol>
<li>given I&#39;m on job invocation form</li>
<li>there should be a field for task description, that will be used for
listing the jobs</li>
<li>the description value should be pregenerated based on the job name
and specified input (something like &quot;Package install: zsh&quot;)</li>
</ol>

<p><strong>Fill in execution properties of the job</strong></p>

<ol>
<li>when I&#39;m on job invocation form</li>
<li>I can override the default values for number of tries, retry
interval, splay time, timeout, remote user...</li>
<li>the overrides are common for all the templates</li>
</ol>

<p><strong>Set the execution time into future</strong> (see <a href="design#scheduling">scheduling</a>
  for more scenarios)</p>

<ol>
<li>when I&#39;m on a job invocation form</li>
<li>then I can specify the time to start the execution at (now by
default)</li>
<li>and I can specify if the targeting should be calculated now or
postponed to the execution time</li>
</ol>

<p><strong>Run a job from host detail</strong></p>

<ol>
<li>given I&#39;m on a host details page</li>
<li>when I click &quot;Run remote command&quot;</li>
<li>then a user dialog opens with job invocation form, with pre-filled
targeting pointing to this particular host</li>
</ol>

<p><strong>Run a job from host index</strong></p>

<ol>
<li>given I&#39;m on a host index page</li>
<li>when I click &quot;Run remote command&quot;</li>
<li>then a user dialog opens with job invocation form, with prefiled
targeting using the same search that was used in the host index page</li>
</ol>

<p><strong>Invoke a job with single remote execution provider</strong></p>

<ol>
<li>given I have only one provider available in my installation</li>
<li>and I&#39;m on job invocation form</li>
<li>when I choose the job to execute</li>
<li>then only the template for this provider is available to run and
asking for user inputs</li>
</ol>

<p><strong>Invoke a job with hammer</strong></p>

<ol>
<li>given I&#39;m using CLI</li>
<li>then I can run a job with ability to specify:

<ul>
<li>targeting with scoped search or bookmark_id</li>
<li>job name to run</li>
<li>templates to use for the job</li>
<li>inputs on per-template basis</li>
<li>execution properties as overrides for the defaults coming from the template</li>
<li><code>start_at</code> value for execution in future</li>
<li>in case of the start_at value, if the targeting should be static
vs. dynamic</li>
<li>whether to wait for the job or exit after invocation (--async
option)
<em>OPEN QUESTION</em>: should we unify the common inputs in all templates to
specify them only once: not scoping  the input by template? Maybe an
inputs catalog (with both defined name and semantic) might help.</li>
</ul></li>
</ol>

<p><strong>Re-invoke a job</strong></p>

<ol>
<li>given I&#39;m in job details page</li>
<li>when I choose re-run</li>
<li>then a user dialog opens with job invocation form, with prefiled
targeting parameters from the previous execution
1 and I can override all the values (including targeting, job,
templates and inputs)</li>
</ol>

<p><strong>Re-invoke a job for failed hosts</strong></p>

<ol>
<li>given I&#39;m in job details page</li>
<li>when I choose re-run</li>
<li>then a user dialog opens with job invocation form, with prefiled
targeting parameters from the previous execution
1 and I can override all the values (including targeting, job,
templates and inputs)</li>
<li>I can choose in the targeting to only run on hosts that failed with
the job previously</li>
</ol>

<p><strong>Edit a bookmark referenced by pending job invocation</strong></p>

<ol>
<li>given I have a pending execution task which targeting was created
from a bookmark</li>
<li>when I edit the bookmark</li>
<li>then I should be notified about the existence of the pending tasks
with ability to update the targeting (or cancel and recreate the
invocation)</li>
</ol>

<h2 id="design">Design</h2>

<p>Class diagram of Foreman classes</p>

<p><img src='/foreman-rex///images/plantuml/92f06afd5a5fce9b76f46d0f2a4301c8.png'></p>

<p>Query is copied to Targeting, we don&#39;t want to propagate any later
changes to Bookmark to already planned job executions.</p>

<p>We can store link to original bookmark to be able to
compare changes later.</p>

<p>For JobInvocation we forbid later editing of Targeting.</p>

<h1 id="command-execution">Command Execution</h1>

<h2 id="user-stories">User Stories</h2>

<ul>
<li><p>As a user I want to be able to cancel command which hasn&#39;t been started yet.</p></li>
<li><p>As a user I want to be able to cancel command which is in progress
(if supported by specific provider…)</p></li>
<li><p>As a user I want job execution to fail after timeout limit.</p></li>
<li><p>As a user I want to job execution to be re-tried
based on the tries and retry interval values given in the invocation</p></li>
<li><p>As a user I want to job execution on multiple hosts to be spread
using the splay value</p></li>
<li><p>As a user I want the job execution to be performed as a user that
was specified on the job invocation</p></li>
<li><p>As a user I want an ability to retry the job execution when the host
checks in (support of hosts that are offline by the time the
execution).</p></li>
</ul>

<h2 id="scenarios">Scenarios</h2>

<p>** Cancel pending bulk task: all at once**</p>

<ol>
<li>given I&#39;ve set a job to run in future on multiple hosts</li>
<li>when I click &#39;cancel&#39; on the corresponding bulk task</li>
<li>then the whole task should be canceled (including all the sub-tasks
on all the hosts)</li>
</ol>

<p>** Cancel pending bulk task: task on specific host **</p>

<ol>
<li>given I&#39;ve set a job to run in future on multiple hosts</li>
<li>when I show the task representation on a host details page</li>
<li>when I click &#39;cancel&#39; on the task</li>
<li>then I should be offered whether I should cancel just this
instance or the whole bulk task on all hosts</li>
</ol>

<p>** Fail after timeout **</p>

<ol>
<li>given I&#39;ve invoked a job</li>
<li>when the job fails to start in given specified timeout</li>
<li>then the job should be marked as failed due to timeout</li>
</ol>

<p>** Retried task **</p>

<ol>
<li>given I&#39;ve invoked a job</li>
<li>when the job fails to start at first attemt</li>
<li>then the executor should wait for retry_timeout period</li>
<li>and it should reiterate with the attempt based on the tries number</li>
<li>and I should see the information about the number of retries</li>
</ol>

<h2 id="design">Design</h2>

<p>Class diagram for jobs running on multiple hosts</p>

<p><img src='/foreman-rex///images/plantuml/f90e4db6e7f787dd9833be86854125a3.png'></p>

<p>Class diagram for jobs running a single host</p>

<p><img src='/foreman-rex///images/plantuml/b5775ac7d4be15c8d1d4dc916c57b1fc.png'></p>

<p>We should take facts from Foreman rather gather them during runtime (different result than expected when planning, performance)</p>

<h2 id="open-questions">Open questions</h2>

<ol>
<li>Splay Time versus Splay Count

<ul>
<li>Count would allow for better adjustments for performance tolerance</li>
<li>Time would fit into maintenance windows better</li>
<li>How would either of these be implemented?</li>
</ul></li>
</ol>

<h1 id="reporting">Reporting</h1>

<h2 id="user-stories">User Stories</h2>

<h2 id="design">Design</h2>

<h1 id="scheduling">Scheduling</h1>

<h2 id="user-stories">User Stories</h2>

<h2 id="design">Design</h2>

<h1 id="katello-workflow-integration">Katello Workflow Integration</h1>

<h2 id="user-stories">User Stories</h2>

<h2 id="design">Design</h2>

<h1 id="security">Security</h1>

<h2 id="user-stories">User Stories</h2>

<h2 id="design">Design</h2>

<h1 id="orchestration">Orchestration</h1>

<h2 id="user-stories">User Stories</h2>

<h2 id="design">Design</h2>

        </div>
      </div>
    </div>
  </div>

<script type="text/javascript">
  $(function() {
    //Calls the tocify method on your HTML div.
    $("#toc").tocify({context: '#doc', scrollTo: '60', selectors: "h1,h2,h3"});
  });
</script>

<div class="footer">
  <div class="container">
    <p>This web site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_GB">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.  Source available: <a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/theforeman/theforeman.org" rel="dct:source">github/theforeman/theforeman.org</a>.</p>
		<a href="https://plus.google.com/102496134326414788199" rel="publisher">Google+ community</a>
  </div>
</div>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2134730-5']);
  _gaq.push(['_trackPageview']);

  (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</body>
</html>

